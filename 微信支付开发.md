# 微信支付开发
==
## 1. 微信支付类型及场景

* 公众号支付<br>
  场景：在微信内打开，必须关注公众号，页面中调用JSSDK
* 二维码支付<br>
  * 模式一  
    预先生成二维码，不含金额。扫码回调到商户后台，计算金额后在下单
    
  * 模式二  
   	 生成二维码时即出入金额，扫码后直接支付
* App支付
* H5支付  
	场景：只能在微信外打开，支付时直接唤起微信

## 2. 开发配置
1. 微信认证，开通微信支付，域名备案
2. 公众平台配置  
   配置路径：公众平台->公众号设置->功能设置  
	* 设置JS接口安全域名
	* 业务域名
	* 网页授权域名  
	**注：需要上传验证文件到服务器**
3. 商户平台配置  
   配置路径：商户平台>产品中心>支付配置
   * 公众号支付  
     JSAPI支付授权目录  
     配置到父级controller即可
   * 扫码支付
   	  配置回调链接  
   	  具体的回调方法，只能有一个扫码回调方法
   * H5支付  
     配置域名即可，支持二级域名  
     示例：www.xxx.com
     
### 3. 开发流程
  1. 公众号支付
  	* 获取openId  
  	  通过oauth回调获取授权code，code获取openId，跳转到业务页面
  	* 统一下单接口，获取prepay_id  
  	  根据业务，计算金额，生成订单id，交易流水id，调用统一下单接口，获取到prepay_id
  	* 生成JSSDK请求参数  
  	  通过prepay_id生成签名及其他参数，返回到前台页面
  	* 前台页面调用JSSDK  
  	  前台页面接收到后台传来的请求参数，调用chooseWxPay方法，发起微信支付
  2. 二维码支付  
  
    **注：code_url两小时内有效**
    1. 模式一
      
       **二维码中不含金额，扫码后回调生成金额**
       1. 根据业务生成订单生成product_id并生成二维码，无需调用接口
       2. 用户扫码后回调到商户平台中配置的扫描回调地址
       3. 统一下单  
       回调回来获取到product_id,openId,根据product_id计算金额，调用统一下单接口，获取prepay_id
       4. 根据prepay_id组织报文，返回给微信  
       **2，3，4为连贯步骤，回调后返回报文给微信后台**
    
    2. 模式二  
       简单模式，直接将金额写入二维码
       * 根据业务生成订单，计算金额，配置回调地址
       * 统一下单接口，返回code_url
       * 用户扫码，支付成功后回调到notify_url

  3. H5支付
     1. 前端页面请求到后台
     2. 后台根据业务生成订单,计算金额
     3. 统一下单接口，获取prepay_id
     4. 组织报文，返回给微信  
     **注：2，3，4为连贯步骤**
       
     